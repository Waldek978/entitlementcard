language: dart
dist: focal
addons:
  apt:
    packages:
      - lib32stdc++6
env:
  global:
    # environment variable secretsJson, containing the content of frontend/secrets.json
    - secure: "mHP4sBJUc16sLkpOCgShcF7ZMShLdboQaDjRQYk88RftZXD4dwXpETX2Azs4ry3kBcPWiSvebRUreMJb/Pu/8DfORK9re7gyD5lmxUZBlVMb4qbaQoJ9gHNMsGe9VhA3jxX6M+F8m5yzdX9ZjF2K3CYqVOXl6C+z3McZl9EuovSpy0lPYKqoL0tpUOi4qZkSp1vG9w3ChhR4/3rTprC0pDVmjLyIvFTQ1Q6A7LuVmY5tpTCvKigwlGHJi5L/xOTYJZw6LgMtcF6LjYPX94U6yQzpqigLA2tt2N396BmBu4FoH8b6Dhr5zk5rJZK1bw+rTKMFjcW/eSnmPar+Z4/A0GOnTtGA6zkcDouFQdA3zdQgytWTjiaNnPXCwjgbpRefAr9yCjynwllhnL/7uk5kjyTdB6DakoSB5zeid9rBLuL63Y/4/Pafs7mlgTNVLVcJd+bsOPgUurpT5182owJkhCVg94Hg8xsKt5CcftSFSNEUSRW35t91NWC6KBjGOTUBDHMdL7+lvppfF9bRfC+tKJX2WidZsnxBZ6RmL/CXYMQ7j2+AizGXvHotS6729n5mrCwHyCYEYCuYnRyJ+PZzuTmA0ycq/+4jITqVH+c4WPEA++3QE7XJokDIb7FB4eqy+3qDBX3CCzjR78cKXlN+uv7EmXgh8iL2PJBWoLq1Xu8="

stages:
  - test
  - build
  - name: deploy
    if: branch = main

jobs:
  include:
    - stage: test
      name: "Frontend flutter tests"
      install: scripts/setUpFlutter.sh
      script: cd frontend && ./flutter/bin/flutter test
      cache:
        directories:
          - $HOME/.pub-cache

    - stage: build
      name: "Build Android app"
      language: android
      dist: trusty
      android:
        components:
          - tools
          - platform-tools
          - build-tools-29.0.3
          - android-30
          - extra-android-m2repository
        licenses:
          - android-sdk-preview-license-.+
          - android-sdk-license-.+
      install:
        - tar -xf scripts/androidLicenses.tar -C /usr/local/android-sdk
        - scripts/setUpFlutter.sh
      script: cd frontend && ./flutter/bin/flutter build appbundle
      cache:
        directories:
          - $HOME/.pub-cache

    - name: "Build iOS app"
      os: osx
      osx_image: xcode12
      install: scripts/setUpFlutter.sh
      script: cd frontend && ./flutter/bin/flutter build ios --release --no-codesign
      cache:
        directories:
          - $HOME/.pub-cache