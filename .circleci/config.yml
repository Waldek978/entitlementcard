### AUTO GENERATED. DO NOT MODIFY. ###
# This file should be auto generated by the files in the src folder.
# You can update it by running `yarn run circleci:update-config`.
commands:
    check_circleci_config:
        description: This command builds the circle config from the files in src and validates that it is up-to-date and valid.
        steps:
            - run:
                command: curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | sudo bash
                name: Install CircleCI CLI
            - run:
                command: ./scripts/circleci-update-config.sh
                name: Build circle config
            - run:
                command: |
                    FILES_MODIFIED=""
                    setcommit () {
                      FILES_MODIFIED=$(git status -s | grep -i -E '.*circleci/config.yml')
                    }
                    setcommit || true
                    if [ -z "$FILES_MODIFIED" ]
                    then
                      echo "The CircleCI config is up to date."
                      exit 0;
                    else
                      echo "The CircleCI config is not up to date. You can update it by running `yarn run circleci:update-config`."
                      exit 1;
                    fi
                name: CircleCI config up to date
            - run:
                command: circleci config validate
                name: Validate circle config
    install_app_toolbelt:
        steps:
            - setup_npm_global
            - run:
                command: npm install --unsafe-perm -g https://github.com/digitalfabrik/app-toolbelt/archive/refs/heads/main.tar.gz
                name: Install app-toolbelt
    install_dart_linux:
        steps:
            - run:
                command: |-
                    curl -o dart.deb https://storage.googleapis.com/dart-archive/channels/stable/release/3.0.5/linux_packages/dart_3.0.5-1_amd64.deb
                    sudo dpkg -i dart.deb
                name: Install Dart
    install_dart_mac:
        steps:
            - run:
                command: |-
                    brew tap dart-lang/dart
                    brew install dart
                name: Install Dart
    install_fvm:
        steps:
            - run:
                command: |
                    dart pub global activate fvm
                    echo 'export PATH=$HOME/.pub-cache/bin:$PATH' >> $BASH_ENV
                name: Install FVM
            - restore_cache:
                keys:
                    - fvm-0-{{ checksum ".fvm/fvm_config.json" }}-{{ arch }}
            - run:
                command: fvm install
                name: Install Flutter
            - save_cache:
                key: fvm-0-{{ checksum ".fvm/fvm_config.json" }}-{{ arch }}
                paths:
                    - .fvm
                    - ~/fvm/
            - run:
                command: fvm flutter --version
                name: Show Flutter version
            - run:
                command: fvm flutter config --no-analytics
                name: Configure Flutter
    install_protobuf_linux:
        steps:
            - run:
                command: |
                    curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v21.11/protoc-21.11-linux-x86_64.zip"
                    unzip protoc*.zip -d $HOME/.local
                    echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
                name: Install protobuf from GitHub
            - run:
                command: dart pub global activate protoc_plugin
                name: Install Flutter plugin
    install_protobuf_mac:
        steps:
            - run:
                command: |
                    curl -LO "https://github.com/protocolbuffers/protobuf/releases/download/v21.11/protoc-21.11-osx-x86_64.zip"
                    unzip protoc*.zip -d $HOME/.local
                    echo 'export PATH=$HOME/.local/bin:$PATH' >> $BASH_ENV
                name: Install protobuf
            - run:
                command: dart pub global activate protoc_plugin
                name: Install Flutter plugin
    setup_npm_global:
        steps:
            - run:
                command: |-
                    mkdir -p ~/.npm-global
                    npm config set prefix '~/.npm-global'
                    echo 'export PATH=~/.npm-global/bin:"$PATH"' >> "$BASH_ENV"
                name: Setup npm
jobs:
    build_administration:
        docker:
            - image: cimg/node:19.1.0
        environment: null
        steps:
            - checkout:
                path: ~/project
            - restore_cache:
                keys:
                    - v1-node-modules-{{ checksum "package.json" }}-{{checksum "package-lock.json" }}
            - install_dart_linux
            - install_protobuf_linux
            - run:
                command: '[ ! -d node_modules ] && npm ci --loglevel warn --yes || echo package.json and package-lock.json unchanged. Using cache.'
                name: Install node dependencies
            - run: |
                npm run generate-graphql
                npm run generate-protobuf
            - run:
                command: npm run lint
                name: Lint
            - run:
                command: npm run test -- --maxWorkers=2
                name: Test
            - run:
                command: npm run build
                name: Build
            - save_cache:
                key: v1-node-modules-{{ checksum "package.json" }}-{{checksum "package-lock.json" }}
                paths:
                    - node_modules
            - store_artifacts:
                path: build
            - persist_to_workspace:
                paths:
                    - administration/build
                root: ~/project
        working_directory: ~/project/administration
    build_android:
        docker:
            - image: cimg/android:2022.09.2-node
        environment:
            GRADLE_OPTS: -Dorg.gradle.jvmargs="-Xmx2048m" -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        parameters:
            buildConfig:
                description: Name of the build config to use
                type: string
            flutterFlavor:
                description: Flutter Flavor to use
                type: string
        resource_class: large
        steps:
            - checkout:
                path: ~/project
            - install_dart_linux
            - install_fvm
            - install_app_toolbelt
            - install_protobuf_linux
            - run:
                command: |
                    fvm flutter pub get --enforce-lockfile
                    fvm flutter precache --android
                name: Install Flutter Packages
            - run:
                command: |
                    fvm flutter pub run build_runner build --define "df_build_config=name=<< parameters.buildConfig >>"
                name: Build Runner
            - run:
                command: |
                    fvm flutter build apk --dart-define=environment=production --flavor << parameters.flutterFlavor >> --release -t lib/main.dart
                name: Build
            - store_artifacts:
                path: build/app/outputs/flutter-apk/
        working_directory: ~/project/frontend
    build_backend:
        docker:
            - image: cimg/openjdk:17.0.6-node
        environment:
            _JAVA_OPTIONS: -Xmx3g
            GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2
        steps:
            - checkout:
                path: ~/project
            - run: git submodule sync
            - run: git submodule update --init
            - restore_cache:
                key: v2-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - restore_cache:
                key: v2-gradle-cache-{{ checksum "build.gradle.kts" }}
            - run:
                command: |
                    ./gradlew run --args="graphql-export ../specs/backend-api.graphql"
                    git diff --exit-code
                name: Check that GraphQL scheme is stable
            - run:
                command: |
                    ./gradlew test
                name: Test
            - run: ./gradlew build
            - save_cache:
                key: v2-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
                paths:
                    - .gradle/wrapper
            - save_cache:
                key: v2-gradle-cache-{{ checksum "build.gradle.kts" }}
                paths:
                    - .gradle/caches
            - store_artifacts:
                path: build/libs
            - persist_to_workspace:
                paths:
                    - backend/build/distributions/*
                root: ~/project
        working_directory: ~/project/backend
    build_ios:
        macos:
            xcode: 14.0.0
        parameters:
            buildConfig:
                description: Name of the build config to use
                type: string
            flutterFlavor:
                description: Flutter Flavor to use
                type: string
        steps:
            - checkout:
                path: ~/project
            - install_dart_mac
            - install_fvm
            - install_app_toolbelt
            - install_protobuf_mac
            - run:
                command: |
                    fvm flutter pub get --enforce-lockfile
                    fvm flutter precache --ios
                name: Install Flutter Packages
            - run:
                command: |
                    cd ios
                    pod update # This command is somehow needed: https://github.com/m0nac0/flutter-maplibre-gl/pull/9
                    pod install
                name: Update Pods
            - run:
                command: |
                    fvm flutter pub run build_runner build --define "df_build_config=name=<< parameters.buildConfig >>"
                name: Build Runner
            - run:
                command: |
                    app-toolbelt v0 build-config write-xcconfig "<< parameters.buildConfig >>" ios --directory ios/
                    fvm flutter build ios --dart-define=environment=production --flavor << parameters.flutterFlavor >> --no-codesign --release -t lib/main.dart
                name: Build
        working_directory: ~/project/frontend
    build_martin:
        docker:
            - image: rust:bullseye
        steps:
            - run:
                command: |
                    mkdir -p ~/.ssh
                    touch ~/.ssh/known_hosts
                    echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCj7ndNxQowgcQnjshcLrqPEiiphnt+VTTvDP6mHBL9j1aNUkY4Ue1gvwnGLVlOhGeYrnZaMgRK6+PKCUXaDbC7qtbW8gIkhL7aGCsOr/C56SJMy/BCZfxd1nWzAOxSDPgVsmerOBYfNqltV9/hWCqBywINIR+5dIg6JTJ72pcEpEjcYgXkE2YEFXV1JHnsKgbLWNlhScqb2UmyRkQyytRLtL+38TGxkxCflmO+5Z8CSSNY7GidjMIZ7Q4zMjA2n1nGrlTDkzwDCsw+wqFPGQA179cnfGWOWRVruj16z6XyvxvjJwbz0wQZ75XK5tKSb7FNyeIEs4TT4jk+S4dhPeAUC5y+bDYirYgM4GC7uEnztnZyaVWQ7B381AK4Qdrwt51ZqExKbQpTUNn+EjqoTwvqNj4kqx5QUCI0ThS/YkOxJCXmPUWZbhjpCg56i+2aB6CmK2JGhn57K5mj0MNdBXA4/WnwH6XoPWJzK5Nyu2zB3nAZp+S5hpQs+p1vN1/wsjk=" >> ~/.ssh/known_hosts
                    git clone git@github.com:urbica/martin.git ~/martin
                    git config advice.detachedHead false
                    git checkout ed14582a8f5c3e11bfb165f3b012edccd929b479
                name: Checkout
            - restore_cache:
                keys:
                    - v1-cargo-{{ checksum "Cargo.toml" }}-{{ checksum "Cargo.lock" }}
            - run:
                command: |
                    apt update
                    apt install -y openssl libssl-dev
                name: Install OpenSSL
            - run:
                command: |
                    cargo build --release --target x86_64-unknown-linux-gnu
                name: Build
            - save_cache:
                key: v1-cargo-{{ checksum "Cargo.toml" }}-{{ checksum "Cargo.lock" }}
                paths:
                    - ~/.cargo
                    - target
            - run:
                command: |
                    mkdir -p /tmp/artifacts/martin
                    cp target/x86_64-unknown-linux-gnu/release/martin /tmp/artifacts/martin
                name: Prepare storing
            - store_artifacts:
                path: /tmp/artifacts
            - persist_to_workspace:
                paths:
                    - martin/martin
                root: /tmp/artifacts
        working_directory: ~/martin
    check:
        docker:
            - image: cimg/node:19.1.0-browsers
        environment:
            TOTAL_CPUS: 1
            TZ: Europe/Berlin
        resource_class: small
        shell: /bin/bash -eo pipefail
        steps:
            - checkout
            - check_circleci_config
    check_frontend:
        docker:
            - image: cimg/node:19.1.0-browsers
        resource_class: small
        steps:
            - checkout:
                path: ~/project
            - browser-tools/install-chrome
            - install_dart_linux
            - install_fvm
            - install_app_toolbelt
            - install_protobuf_linux
            - run:
                command: fvm flutter pub get --enforce-lockfile
                name: Install Flutter Packages
            - run:
                command: fvm dart format -l 120 -o none --set-exit-if-changed .
                name: Check Formatting
            - run:
                command: |
                    # Statically use "bayern" build config for analyzing here
                    fvm flutter pub run build_runner build --define "df_build_config=name=bayern"
                name: Build Runner
            - run:
                command: |
                    fvm flutter analyze --fatal-infos --fatal-warnings
                    fvm flutter analyze pubs/df_build_config --fatal-infos --fatal-warnings
                    fvm flutter analyze pubs/df_protobuf --fatal-infos --fatal-warnings
                name: Check Analyzer and Linting
            - run:
                command: |-
                    fvm flutter test
                    fvm flutter test pubs/df_build_config
                    fvm flutter test pubs/df_protobuf
                name: Tests
        working_directory: ~/project/frontend
    check_health_backend:
        docker:
            - image: cimg/base:2023.03
            - environment:
                - POSTGRES_DB=ehrenamtskarte
                - POSTGRES_USER=postgres
                - POSTGRES_PASSWORD=postgres
              image: postgis/postgis:13-3.0-alpine
        steps:
            - checkout:
                path: ~/project
            - attach_workspace:
                at: /tmp/workspace
            - run:
                command: |
                    sudo apt update
                    sudo apt install curl -y
                name: Install Curl
            - run:
                command: sudo apt install ca-certificates-java
                name: Install ca-certificates-java
            - run:
                command: sudo apt install openjdk-17-jre-headless -y
                name: Install openjdk-17-jre-headless
            - run:
                command: sudo dpkg -i /tmp/workspace/debs/eak-backend*.deb
                name: Install backend
            - run:
                command: /opt/ehrenamtskarte/backend/bin/backend migrate
                name: Run migrate
            - run:
                background: true
                command: /opt/ehrenamtskarte/backend/bin/backend execute
                name: Start backend
            - run:
                command: curl --retry 120 --retry-delay 1 --retry-all-errors http://0.0.0.0:8000/health
                name: Check health
    deploy:
        docker:
            - image: cimg/base:2022.09
        parameters:
            server:
                enum:
                    - entitlementcard.tuerantuer.org
                    - entitlementcard-test.tuerantuer.org
                type: enum
            ssh-host-fingerprint:
                enum:
                    - '|1|dkYQrdGB1QML0o+POL3QzAkBbek=|b4Tm0Ymh82UKyZPJfVKy4t+MFV8= ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIONuARu18Fktz+j4QosI+nRqgMnFOMgE7OZLuTOwgZ0k'
                    - '|1|iikuvSrIo3wkj+EqUgLRMsAq6yk=|r9bSjkawWFa94b45qE/se5Oio5k= ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIED3MwobbCs+ENMLXdyqlJb3bJ26TuIYt977TA3NrN66'
                type: enum
        steps:
            - attach_workspace:
                at: /tmp/workspace
            - add_ssh_keys:
                fingerprints:
                    - a1:3f:a7:c3:ff:12:40:1d:85:de:a7:ab:12:3f:cc:05
            - run:
                command: |-
                    echo "<< parameters.ssh-host-fingerprint >>" >> known_hosts
                    echo "Uploading: " /tmp/workspace/debs/*.deb
                    sftp -b - -o UserKnownHostsFile=known_hosts ci@<< parameters.server >>:/local-apt-repository/ \<<< "put -r /tmp/workspace/debs/*.deb"
                name: SFTP upload
    pack_administration:
        docker:
            - image: debian:11
        steps:
            - checkout:
                path: ~/project
            - attach_workspace:
                at: /tmp/workspace
            - run: ~/project/scripts/pack_deb.sh -v "0.$CIRCLE_BUILD_NUM" -f /tmp/workspace/administration/build -d "Administration backend for the Ehrenamtskarte app" -n "eak-administration"
            - run: |
                mkdir -p /tmp/artifacts/debs
                mv *.deb /tmp/artifacts/debs
            - store_artifacts:
                path: /tmp/artifacts
            - persist_to_workspace:
                paths:
                    - debs/*.deb
                root: /tmp/artifacts
        working_directory: ~/project/administration
    pack_backend:
        docker:
            - image: debian:11
        steps:
            - checkout:
                path: ~/project
            - attach_workspace:
                at: /tmp/workspace
            - run: ~/project/scripts/pack_deb.sh -v "0.$CIRCLE_BUILD_NUM" -t /tmp/workspace/backend/build/distributions/*.tar -s ~/project/scripts/eak-backend.service -d "Backend server for the Ehrenamtskarte app" -n "eak-backend" -c "openjdk-17-jre-headless"
            - run: |
                mkdir -p /tmp/artifacts/debs
                mv *.deb /tmp/artifacts/debs
            - store_artifacts:
                path: /tmp/artifacts
            - persist_to_workspace:
                paths:
                    - debs/*.deb
                root: /tmp/artifacts
        working_directory: ~/project/backend
    pack_martin:
        docker:
            - image: debian:11
        steps:
            - checkout:
                path: ~/project
            - attach_workspace:
                at: /tmp/workspace
            - run:
                command: |
                    cp ~/project/docker/martin-config.yaml config.yaml
                    cp /tmp/workspace/martin/martin .
                    ~/project/scripts/pack_deb.sh -v "0.$CIRCLE_BUILD_NUM" -d "Martin tile server for the Ehrenamtskarte app" -n "eak-martin" -s ~/project/scripts/eak-martin.service -C "/opt/ehrenamtskarte/martin/config.yaml" -M .
                name: Build .deb
            - run:
                command: |
                    mkdir -p /tmp/artifacts/debs
                    mv *.deb /tmp/artifacts/debs
                name: Move .deb to artifacts folder
            - store_artifacts:
                path: /tmp/artifacts
            - persist_to_workspace:
                paths:
                    - debs/*.deb
                root: /tmp/artifacts
        working_directory: ~/project/map-tiles/martin
    pack_meta:
        docker:
            - image: debian:11
        steps:
            - checkout:
                path: ~/project
            - run: ~/project/scripts/pack_deb.sh -v "0.$CIRCLE_BUILD_NUM" -d "Meta package for the Ehrenamtskarte app" -n "eak" -c "eak-backend, eak-administration, eak-martin"
            - run: |
                mkdir -p /tmp/artifacts/debs
                cp *.deb /tmp/artifacts/debs
            - store_artifacts:
                path: /tmp/artifacts
            - persist_to_workspace:
                paths:
                    - debs/*.deb
                root: /tmp/artifacts
        working_directory: ~/project/administration
orbs:
    browser-tools: circleci/browser-tools@1.4.1
    gradle: circleci/gradle@2.2.0
parameters:
    run_backend:
        default: false
        type: boolean
    run_commit:
        default: true
        type: boolean
    run_frontend:
        default: false
        type: boolean
version: 2.1
workflows:
    backend:
        jobs:
            - build_backend
            - build_administration
            - build_martin
            - pack_backend:
                requires:
                    - backend-build
            - check_health_backend:
                requires:
                    - backend-pack
            - pack_administration:
                requires:
                    - administration-build
            - pack_martin:
                requires:
                    - martin-build
            - pack_meta
            - deploy:
                context:
                    - entitlementcard-apt
                filters:
                    branches:
                        only:
                            - /release.*/
                name: deploy-staging
                requires:
                    - backend-pack
                    - backend-health-check
                    - administration-pack
                    - martin-pack
                    - meta-pack
                server: entitlementcard-test.tuerantuer.org
                ssh-host-fingerprint: '|1|dkYQrdGB1QML0o+POL3QzAkBbek=|b4Tm0Ymh82UKyZPJfVKy4t+MFV8= ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIONuARu18Fktz+j4QosI+nRqgMnFOMgE7OZLuTOwgZ0k'
            - deploy:
                context:
                    - entitlementcard-apt
                filters:
                    branches:
                        only:
                            - /release.*/
                name: deploy-production
                requires:
                    - backend-pack
                    - administration-pack
                    - martin-pack
                    - meta-pack
                server: entitlementcard.tuerantuer.org
                ssh-host-fingerprint: '|1|iikuvSrIo3wkj+EqUgLRMsAq6yk=|r9bSjkawWFa94b45qE/se5Oio5k= ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIED3MwobbCs+ENMLXdyqlJb3bJ26TuIYt977TA3NrN66'
        when: << pipeline.parameters.run_backend >>
    commit:
        jobs:
            - check
            - build_backend
            - pack_backend:
                requires:
                    - build_backend
            - check_health_backend:
                requires:
                    - pack_backend
            - check_frontend
        when: << pipeline.parameters.run_commit >>
    frontend:
        jobs:
            - check_frontend
            - build_android:
                buildConfig: bayern-floss
                flutterFlavor: BayernFloss
                name: frontend-android-build-bayern-floss
                requires:
                    - check-frontend
            - build_android:
                buildConfig: bayern
                flutterFlavor: Bayern
                name: frontend-android-build-bayern
                requires:
                    - check-frontend
            - build_ios:
                buildConfig: bayern
                flutterFlavor: Bayern
                name: frontend-ios-build-bayern
                requires:
                    - check-frontend
            - build_android:
                buildConfig: nuernberg
                flutterFlavor: Nuernberg
                name: frontend-android-build-nuernberg
                requires:
                    - check-frontend
            - build_ios:
                buildConfig: nuernberg
                flutterFlavor: Nuernberg
                name: frontend-ios-build-nuernberg
                requires:
                    - check-frontend
        when: << pipeline.parameters.run_frontend >>

